<% if(!load_chunk){%> 
    <%- include('../shared/page-header') %>
    <%- include('../shared/top-page') %>
    <div class="page-content">
  <%}%>
			<div class="container-fluid">
				<%- include('../shared/page-title') %>
				<div class="d-flex flex-column-fluid">
                    <!--begin::Container-->
                    <div class="container">
                       <!--begin::Card-->                       
                       <div class="card">                                 
                          <div class="card-body">
                              <div class='row'>
                                <div class='col-lg-7'>
                                    <h4 class="card-title">Suppliers</h4>
                                    <p class="text-muted pt-2 font-size-sm">Manage all the suppliers who offer you products and or services.</p>
                                    
                                  </div>
                                  <div class='col-lg-5 text-right' style="margin:auto;">                                   								  
                                    <button data-toggle="modal" data-target="#mdl_new_supplier" class="btn btn-info small-block px-4 mt-0 mb-3 mr-2"  >+ Add New Supplier</button>
                                 </div>
                              </div>
                            <div class='col-12'>
                                <hr>
                                 <!--begin: Datatable-->
                             <table class="table table-nowrap border dt-responsive table-hover" id="tbl_suppliers" style="width:100%">
                                <thead>
                                   <tr>
                                      <th>Full Name</th>
                                      <th>Email Address</th>
                                      <th>Phone Number</th>                                      
                                      <th>Supplier Type</th> 
                                      <th>Balance</th> 
                                      <th>Actions</th>                                          
                                   </tr>
                                </thead>
                             </table>
                             <!--end: Datatable-->
                            </div>
                          </div>
                       </div>
                       <!--end::Card-->
                    </div>
                    <!--end::Container-->
                 </div>
			</div>
			<!-- container-fluid -->

            <div id="mdl_new_supplier" class="modal fade" role="dialog">
                <div class="modal-dialog modal-lg">
                   <!-- Modal content-->
                   <div class="modal-content">
                      <div class="modal-header">
                         <h5 class="modal-title">New Supplier</h5>
                         <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                         <i class='bx bx-x'></i>
                         </button>
                      </div>
                      <form id="frm_new_supplier" method="post" action ="#">
                         <div class="modal-body">
                            <div class="row">  
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="supplier_type">Supplier Type <span class="text-danger">*</span></label>
                                        <select class="form-control custom-select" name="supplier_type" id="supplier_type">
                                            <option value="Individual" >Individual</option>
                                            <option value="Company" >Company</option>
                                        </select>
                                    </div>
                                </div>                                              
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="first_name">First Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="first_name" id="first_name" maxlength="100" autocomplete="off"  required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="last_name">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="last_name" id="last_name" maxlength="100" autocomplete="off"  required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">                                                
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="email_address">Email Address <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" name="email_address" id="email_address" maxlength="255"  autocomplete="off" required>                                        
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="last_name">Phone Number</label>
                                        <input type="text" class="form-control" name="phone_number" id="phone_number"  autocomplete="off" maxlength="12">
                                    </div>
                                </div>                                
                            </div>                                                   
                         </div>
                         <div class="modal-footer">     
                            <button id="btn_save_supplier" type="submit" class="btn btn-success">Save Supplier</button>      
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                         </div>
                      </form>
                   </div>
                </div>
             </div>	

             <div id="mdl_edit_supplier" class="modal fade" role="dialog">
                <div class="modal-dialog modal-lg">
                   <!-- Modal content-->
                   <div class="modal-content">
                      <div class="modal-header">
                         <h5 class="modal-title">Edit Supplier</h5>
                         <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                         <i class='bx bx-x'></i>
                         </button>
                      </div>
                      <form id="frm_edit_supplier" method="post" action ="#">
                          <input type="hidden" name="supplier_code" id="edit_supplier_code" value=""/>
                         <div class="modal-body">
                            <div class="row">       
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="edit_supplier_type">Supplier Type <span class="text-danger">*</span></label>
                                        <select class="form-control custom-select" name="supplier_type" id="edit_supplier_type">
                                            <option value="Individual" >Individual</option>
                                            <option value="Company" >Company</option>
                                        </select>
                                    </div>
                                </div>                                              
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="first_name">First Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="first_name" id="edit_first_name" maxlength="100" autocomplete="off"  required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="last_name">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="last_name" id="edit_last_name" maxlength="100" autocomplete="off"  required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">                                                
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="email_address">Email Address <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" name="email_address" id="edit_email_address" maxlength="255"  autocomplete="off" required>                                        
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="last_name">Phone Number</label>
                                        <input type="text" class="form-control" name="phone_number" id="edit_phone_number"  autocomplete="off" maxlength="12">
                                    </div>
                                </div>                                
                            </div>                                                     
                         </div>
                         <div class="modal-footer">     
                            <button id="btn_edit_supplier" type="submit" class="btn btn-success">Update Supplier</button>      
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                         </div>
                      </form>
                   </div>
                </div>
             </div>	

            <% if(!load_chunk){%> </div> <%- include('../shared/page-footer') %> <%- include('../shared/admin-scripts') %> <%}%>

<script>
    window.onload=function(){window.jQuery||window.location.reload()};
$(document).ready(function(){
    $('input[type="checkbox"]').on("change",function(){this.value=this.checked?1:0}).change();
    
   
        
        $("#frm_new_supplier").validate({
                  rules: {                   
                    first_name:{
                        required: true,
                          minlength:3,
                          maxlength: 100   
                    },
                    last_name:{
                        required: true,
                          minlength:3,
                          maxlength: 100   
                    },
                    email_address:{
                        remote:"<%= base_url %>/suppliers/exists",
                          email: true,
                          required: true,
                          maxlength: 255   
                    },
                    phone_number:{                     
                        maxlength: 12,
                        minlength:8
                    }                   
                  },
                  messages: {
                    first_name:{
                        required: "Please enter the first name",
                          minlength:"First name should be between 1 and 100 characters",
                          maxlength: "First name should be between 1 and 100 characters",   
                    },
                    last_name:{
                        required: "Please enter the last name",
                          minlength:"Last name should be between 1 and 100 characters",
                          maxlength: "Last name should be between 1 and 100 characters",  
                    },
                    email_address:{
                            remote:"A supplier with this email already exists",
                          email: "Please enter a correct email address",
                          required: "Please enter a correct email address",
                          maxlength: "Please enter a correct email address"   
                    },
                    phone_number:{                     
                        maxlength: "Please enter a correct phone number ie 07XXXXXXXX",
                        minlength:"Please enter a correct phone number ie 07XXXXXXXX"
                    }               
                  }
          });

          $("#frm_edit_supplier").validate({
                  rules: {                   
                    first_name:{
                        required: true,
                          minlength:3,
                          maxlength: 100   
                    },
                    last_name:{
                        required: true,
                          minlength:3,
                          maxlength: 100   
                    },
                    email_address:{
                          email: true,
                          required: true,
                          maxlength: 255   
                    },
                    phone_number:{                     
                        maxlength: 12,
                        minlength:8
                    }                  
                  },
                  messages: {
                    first_name:{
                        required: "Please enter the first name",
                          minlength:"First name should be between 1 and 100 characters",
                          maxlength: "First name should be between 1 and 100 characters",   
                    },
                    last_name:{
                        required: "Please enter the last name",
                          minlength:"Last name should be between 1 and 100 characters",
                          maxlength: "Last name should be between 1 and 100 characters",  
                    },
                    email_address:{
                          email: "Please enter a correct email address",
                          required: "Please enter a correct email address",
                          maxlength: "Please enter a correct email address"   
                    },
                    phone_number:{                     
                        maxlength: "Please enter a correct phone number ie 07XXXXXXXX",
                        minlength:"Please enter a correct phone number ie 07XXXXXXXX"
                    }              
                  }
          });


    $("#tbl_suppliers").DataTable({
         responsive: !0,
         searchDelay: 500,
        processing: !0,
         serverSide: true,
         "order": [],
         ajax: {
             url: "<%= base_url %>/suppliers/all",
             type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token}
         },
         columns: [{
             data: null,
             render: function(data, type, row) {
                 return '<a class="dynamic-link text-info" href="<%= base_url %>/suppliers/detailed/'+ data.supplier_code +'">'+ data.full_name +'</a>';
             }
             
         } , {
             data: "email_address"
             
         } ,{
             data: "phone_number"
             
         },{
            data: 'supplier_type'            
         },{
             data: null,
             className: "text-md-left, text-lg-right",
             render: function(data, type, row) {
                 return formatMoney(data.pending_amount);
             }
             
         },
         {
             data:null,
             responsivePriority: -1,
             render:function(data, type, row) {
                 return actionData(data);
             }
         }
         ]
     });

    $("#frm_new_supplier").submit(function(e){
        e.preventDefault();
        var isvalid = $("#frm_new_supplier").valid();
        if(isvalid){
            $('#btn_save_supplier').html('Please wait...');
                      $("#btn_save_supplier").attr("disabled", true);
         var data = new myFormData($(this));
        $.ajax({
                  type: "POST",
                  async: true,  
                  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
                  url: "<%= base_url %>/suppliers/new",
                  data: data,
                  success: function(data) {                     
                    resetSaveButton();                  
                      if (data.Status == 200) {   
                        $('#frm_new_supplier').trigger("reset");
                        $("#mdl_new_supplier").modal("hide");
                        $("#tbl_suppliers").DataTable().ajax.reload();
						showAppNotification('success', data.Message);                      
                      } else {                         
                      showAppNotification('warning', data.Message);
                      }
                  },
                  error: function(err) {                      
					resetSaveButton();
                      showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
                  }
              });
          
        }
      
        
    });

    $("#frm_edit_supplier").submit(function(e){
        e.preventDefault();
        var isvalid = $("#frm_edit_supplier").valid();
        if(isvalid){
            $('#btn_edit_supplier').html('Please wait...');
                      $("#btn_edit_supplier").attr("disabled", true);
         var data = new myFormData($(this));
        $.ajax({
                  type: "POST",
                  async: true,  
                  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
                  url: "<%= base_url %>/suppliers/update",
                  data: data,
                  success: function(data) {                     
                    resetUpdateButton();                  
                      if (data.Status == 200) {   
                        $('#frm_edit_supplier').trigger("reset");
                        $("#mdl_edit_supplier").modal("hide");
                        $("#tbl_suppliers").DataTable().ajax.reload();
						showAppNotification('success', data.Message);                      
                      } else {                         
                      showAppNotification('warning', data.Message);
                      }
                  },
                  error: function(err) {                      
					resetUpdateButton();
                      showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
                  }
              });
          
        }
      
        
    });


});

function actionData(data){
    var btns = '<a class="dropdown-item" href="javascript:void(0)" onclick="editSupplier(\''+ data.supplier_code +'\')">Edit Supplier</a><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteSupplier(\''+ data.supplier_code +'\')">Delete Supplier</a><a class="dropdown-item dynamic-link" href="<%= base_url %>/suppliers/detailed/'+ data.supplier_code +'">Detailed Information</a>';		
		  
			return row_begin + btns + row_end;
}

function resetUpdateButton(){
			        $('#btn_edit_supplier').html('Update Supplier');
                      $("#btn_edit_supplier").attr("disabled", false);
		  }
          
function resetSaveButton(){
			        $('#btn_save_supplier').html('Save Supplier');
                      $("#btn_save_supplier").attr("disabled", false);
		  }

function deleteSupplier(id){
            sharpAlert({
        title: "Confirm?",
        text: "Are you sure you want to delete this supplier?",
        type: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes",
        confirmButtonClass: "btn btn-success mr-2 btn-swal",
        cancelButtonText: "No",
        cancelButtonClass: "btn btn-danger mr-2 btn-swal",
       
        
    },(passed)=>{
        if (passed) {
            $.ajax({
                type: "POST",
                async: true,
                credentials: "same-origin",
                headers: { "CSRF-Token": csrf_token },
                url: "<%= base_url %>/suppliers/delete",
                data: {id: id},
                success: function (data) {
                    if (data.Status == 200) {
                        showAppNotification("success", data.Message);
                        $("#tbl_suppliers").DataTable().ajax.reload();
                    } else {
                        showAppNotification("warning", data.Message);
                    }
                },
                error: function (err) {
                    showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
                },
            });
        }
    });
          }

        function editSupplier(id){
            $.ajax({
                type: "POST",
                async: true,
                credentials: "same-origin",
                headers: { "CSRF-Token": csrf_token },
                url: "<%= base_url %>/suppliers/info",
                data: {id:id},
                success: function (data) {
                    if (data.Status == 200) {
                        var supp = data.Message;                        
                        formDeserialize('frm_edit_supplier', supp); 
                        $("#mdl_edit_supplier").modal("show");

                    } else {
                        showAppNotification("warning", data.Message);
                    }
                },
                error: function (err) {
                    showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
                },
            });
}


</script>
  
<% if(!load_chunk){%> </body></html> <%}%>