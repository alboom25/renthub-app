<% if(!load_chunk){%> 
    <%- include('../shared/page-header') %>
    <%- include('../shared/top-page') %>
    <div class="page-content">
<%}%>
  <div class="container-fluid">

    <%- include('../shared/page-title') %>

     <!--begin::Entry-->
 <div class="d-flex flex-column-fluid">
    <!--begin::Container-->
    <div class="container"> 
       <div class="card">
        <div class="card-body">
          <div class="border-bottom p-2">
             <h5 class="modal-title">Add Tenant Account, <%=property.property_name %></h5>            
          </div>
         
             <form id='frm_new_tenant' class="form mx-6" method='post' action='#'>
                 <input type='hidden' name='property' value="<%=property.property_code%>"/>
                <!--begin::Form Group-->
            <div class="p-2">
                <h6 class='text-dark font-weight-bold'>a). Basics</h6>
                <div class='row'>
                   <div class="form-group col-md-12 col-lg-4">
                      <label>ID No</label>
                      <input type="text" name='id_number' class="form-control" autocomplete="off">
                   </div>
                   <div class="form-group col-md-12 col-lg-4">
                      <label>First Name <span class="text-danger">*</span></label>
                      <input type="text" name='first_name' class="form-control" autocomplete="off">
                   </div>
                   <div class="form-group col-md-12 col-lg-4">
                      <label>Last Name <span class="text-danger">*</span></label>
                      <input type="text" name='last_name' class="form-control" autocomplete="off">
                   </div>
                </div>               
                <div class='row'>
                   <div class="form-group col-sm-12 col-lg-4">
                      <label>Gender <span class="text-danger">*</span></label>
                      <select name='gender' class="form-control custom-select">
                         <option value='Male'>Male</option>
                         <option value='Female'>Female</option>
                         <option value='Other'>Other</option>                       
                      </select>
                   </div>
                   <div class="form-group col-sm-12 col-lg-4">
                      <label>Date of Birth <span class="text-danger">*</span></label>
                      <input class="form-control"  value='2000-01-01' type="date" name='date_of_birth' id='date_of_birth'>
                   </div>
                   <div class="form-group col-sm-12 col-lg-4">
                      <label>Nationality <span class="text-danger">*</span></label>
                      <input name='nationality' type="text" value='Kenyan' class="form-control">
                   </div>
                </div>             
               
                <hr class='dashed'>
                <h6 class='text-dark font-weight-bold'>b). Contact details</h6>
                <div class='row'>
                 <div class="form-group col-sm-12 col-lg-4">
                    <label>Phone No</label>
                    <input class="form-control"  placeholder='07XXXXXXXX' type="text" name='phone_number'>
                 </div>
                 <div class="form-group col-sm-12 col-lg-4">
                     <label>Alt. Phone No</label>
                     <input class="form-control"  placeholder='07XXXXXXXX' type="text" name='alt_phone_number'>
                  </div>
                 <div class="form-group col-sm-12 col-lg-4">
                    <label>Email Address </label>
                    <input name='email_address' type="email" class="form-control">
                 </div>
              </div>     
              <span class="form-text text-muted">Encourage the tenant to provide the details they've registered with, if already registered on Rent Hub</span>
                <hr class='dashed'>
                <h6 class='text-dark font-weight-bold'>c). Emergency Contacts</h6>
                <div class="row mb-10">
                   <div class='col'>
                      <p class='text-dark font-weight-bold'>Contacts/Next of Kins</p>
                      <table id='tbl_contacts' class="table table-striped table-bordered collapsed">
                         <thead>
                            <tr>
                               <th>Name</th>
                               <th>Phone Number</th>
                               <th>Relationship</th>
                            </tr>
                         </thead>
                         <tbody>
                           
                         </tbody>
                      </table>
                      <input type='hidden' name='next_of_kins' id='next_of_kins'>
                      <button type="button" id='add_contact' class="btn btn-light">Add New Row</button>
                   </div>
                </div>           
              
                <hr class='dashed'>
                <h6 class='text-dark font-weight-bold'>d). Documents</h6>
                <div class='row'>
                 <div class="form-group col-sm-12 col-lg-4">
                     <label class='col-12'>Tenant Image </label>
                     <div class='row'>
                         <div class="btn-group  btn-sm btn-block" role="group">
                             <label type="button" for="tenant_picture" class="btn btn-light"><i class='bx bx-paperclip' ></i> Attach</label>                             
                             <label type="button" id='btn_clear_tenant_image' class="btn btn-danger">Clear</label>
                         </div>
                     </div>
                     <input type="file" name="" id='tenant_picture' accept=".png, .jpg, .jpeg" hidden />
                     <input type='hidden' name='tenant_image' id='raw_tenant_image'>
                     <div class='custom-card custom-div border d-flex justify-content-center align-items-center' >
                         <img id='tenant_image_container' class='custom-image'/>
                     </div>
                     
                 </div>
 
                 <div class="form-group col-sm-12 col-lg-4">
                     <label class='col-12'>Id Front</label>
                     <div class='row'>
                         <div class="btn-group  btn-sm btn-block" role="group">
                             <label type="button" for="id_front_picture" class="btn btn-light"><i class='bx bx-paperclip' ></i> Attach</label>                            
                             <label type="button" id='btn_clear_id_front_image' class="btn btn-danger">Clear</label>
                         </div>
                     </div>
                     <input type="file" name="" id='id_front_picture' accept=".png, .jpg, .jpeg" hidden />
                     <input type='hidden' name='id_front_image' id='raw_id_front_image'>                   
                     <div class='custom-card custom-div border d-flex justify-content-center align-items-center' >
                         <img id='id_front_image_container' class='custom-image'/>
                     </div>
                 </div>
 
                 <div class="form-group col-sm-12 col-lg-4">
                     <label class='col-12'>Id Back</label>
                     <div class='row'>
                         <div class="btn-group  btn-sm btn-block" role="group">
                             <label type="button" for="id_back_picture" class="btn btn-light"><i class='bx bx-paperclip' ></i> Attach</label>                            
                             <label type="button" id='btn_clear_id_back_image' class="btn btn-danger ">Clear</label>
                         </div>
                     </div>
                     <input type="file" name="" id='id_back_picture' accept=".png, .jpg, .jpeg" hidden />
                     <input type='hidden' name='id_back_image' id='raw_id_back_image'>                    
                     <div class='custom-card custom-div border d-flex justify-content-center align-items-center' >
                         <img id='id_back_image_container' class='custom-image'/>
                     </div>
                 </div>
                 
                </div> 
                <span class="form-text text-muted">Make sure to choose the correct files. You may not be able to edit them later</span>
            </div>
                
                <div class="d-flex flex-row justify-content-end border-top pt-2 mx-6">
                    <a href="<%=base_url %>/agent/properties/<%=property.property_code%>?dest=tenants" class="btn btn-danger dynamic-link mr-2">Cancel</a>
                    <button id='btn_save_tenant' type="button" class="btn btn-success">Save New</button>
                 </div>
             </form>
               
          
        </div>   
       </div>
    </div>
      <!--end::Container-->
 </div>
 
 <div id="tenant_image_modal" class="modal" role="dialog">
     <div class="modal-dialog">
        <div class="modal-content">
           <div class="modal-header">
              <h5 class="modal-title">Crop Image</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <i class='bx bx-x text-weight-bold' ></i>
            </button>
           </div>
           <div class="modal-body">
              <div class="row">
                 <div class="col-lg-12 text-center">
                    <div id="cropped_tenant_image" ></div>
                 </div>
              </div>
           </div>
           <div class="modal-footer">
              <button id='btn_tenant_image_cropped' class="btn btn-success">Done Cropping</button>
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
           </div>
        </div>
     </div>
  </div>
 
 
  <div id="id_front_image_modal" class="modal" role="dialog">
     <div class="modal-dialog">
        <div class="modal-content">
           <div class="modal-header">
              <h5 class="modal-title">Crop Image</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <i class='bx bx-x text-weight-bold' ></i>
            </button>
           </div>
           <div class="modal-body">
              <div class="row">
                 <div class="col-lg-12 text-center">
                    <div id="cropped_id_front_image" ></div>
                 </div>
              </div>
           </div>
           <div class="modal-footer">
              <button id='btn_id_front_image_cropped' class="btn btn-success">Done Cropping</button>
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
           </div>
        </div>
     </div>
  </div>
 
  <div id="id_back_image_modal" class="modal" role="dialog">
     <div class="modal-dialog">
        <div class="modal-content">
           <div class="modal-header">
              <h5 class="modal-title">Crop Image</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <i class='bx bx-x text-weight-bold' ></i>
            </button>
           </div>
           <div class="modal-body">
              <div class="row">
                 <div class="col-lg-12 text-center">
                    <div id="cropped_id_back_image" ></div>
                 </div>
              </div>
           </div>
           <div class="modal-footer">
              <button id='btn_id_back_image_cropped' class="btn btn-success">Done Cropping</button>
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
           </div>
        </div>
     </div>
  </div>
      
  </div> <!-- container-fluid -->
  <% if(!load_chunk){%> </div> <%- include('../shared/page-footer') %> <%- include('../shared/admin-scripts') %> <%}%>
<style>
    .cr-boundary{max-width:100%;}
    
</style>
<!--custom scripts-->

 

<script >
    window.onload=function(){window.jQuery||window.location.reload()};
    $(document).ready(function() {        
        var now = new Date();
        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);
        var bday = now.getFullYear()-18+"-"+(month)+"-"+(day) ;
        $("#date_of_birth").val(bday);
      
            $tenant_image_crop = $('#cropped_tenant_image').croppie({
            enableExif: true,
            viewport: {
                width: 200,
                height: 200,
                type: 'square' //circle
            },
            boundary: {
                width: 300,
                height: 300
            }
        });

        $('#tenant_picture').on('change', function() {
            var reader = new FileReader();
            reader.onload = function(event) {
                $tenant_image_crop.croppie('bind', {
                    url: event.target.result
                }).then(function() {
                    //console.log('jQuery bind complete');
                });
            }
            reader.readAsDataURL(this.files[0]);
            $('#tenant_image_modal').modal('show');
        });

        $('#btn_tenant_image_cropped').on('click', function(ev) {
            $tenant_image_crop.croppie('result', {
                type: 'base64',
                format: 'jpeg',
                size: {
                    width: 200,
                    height: 200
                }
            }).then(function(data) {
                $('#tenant_image_modal').modal('hide');
                var block = data.split(";");
                var image_data = block[1].split(",")[1];
                $('#raw_tenant_image').val(image_data);
                $("#tenant_image_container").attr('src', data);
            });
        });

        $("#btn_clear_tenant_image").click(function(e) {
            $("#tenant_image_container").attr('src', "");
            $('#raw_tenant_image').val("");
        });

        // id front start

        $id_front_image_crop = $('#cropped_id_front_image').croppie({
            enableExif: true,
            viewport: {
                width: 336,
                height: 192,
                type: 'square' //circle
            },
            boundary: {
                width: 400,
                height: 300
            }
        });

        $('#id_front_picture').on('change', function() {
            var reader = new FileReader();
            reader.onload = function(event) {
                $id_front_image_crop.croppie('bind', {
                    url: event.target.result
                }).then(function() {
                    //console.log('jQuery bind complete');
                });
            }
            reader.readAsDataURL(this.files[0]);
            $('#id_front_image_modal').modal('show');
        });

        $('#btn_id_front_image_cropped').on('click', function(ev) {
            $id_front_image_crop.croppie('result', {
                type: 'base64',
                format: 'jpeg',
                size: {
                    width: 336,
                    height: 192
                }
            }).then(function(data) {
                $('#id_front_image_modal').modal('hide');
                var block = data.split(";");
                var image_data = block[1].split(",")[1];
                $('#raw_id_front_image').val(image_data);
                $("#id_front_image_container").attr('src', data);
            });
        });

        $("#btn_clear_id_front_image").click(function(e) {
            $("#id_front_image_container").attr('src', "");
            $('#raw_id_front_image').val("");
        });
        // id front end


        // id back start
        $id_back_image_crop = $('#cropped_id_back_image').croppie({
            enableExif: true,
            viewport: {
                width: 336,
                height: 192,
                type: 'square' //circle
            },
            boundary: {
                width: 400,
                height: 300
            }
        });

        $('#id_back_picture').on('change', function() {
            var reader = new FileReader();
            reader.onload = function(event) {
                $id_back_image_crop.croppie('bind', {
                    url: event.target.result
                }).then(function() {
                    //console.log('jQuery bind complete');
                });
            }
            reader.readAsDataURL(this.files[0]);
            $('#id_back_image_modal').modal('show');
        });

        $('#btn_id_back_image_cropped').on('click', function(ev) {
            $id_back_image_crop.croppie('result', {
                type: 'base64',
                format: 'jpeg',
                size: {
                    width: 336,
                    height: 192
                }
            }).then(function(data) {
                $('#id_back_image_modal').modal('hide');
                var block = data.split(";");
                var image_data = block[1].split(",")[1];
                $('#raw_id_back_image').val(image_data);
                $("#id_back_image_container").attr('src', data);
            });
        });

        $("#btn_clear_id_back_image").click(function(e) {
            $("#id_back_image_container").attr('src', "");
            $('#raw_id_back_image').val("");
        });

        //id back end


 

        $('#tbl_contacts').SetEditable({
            columnsEd: "0,1,2",
            $addButton: $('#add_contact')
        });

       
            $("#frm_new_tenant").validate({
            rules: {
                first_name: {
                    required: true,
                    minlength: 3,
                    maxlength: 30
                },
                last_name: {
                    required: true,
                    minlength: 3,
                    maxlength: 30
                },
                id_number: {
                    maxlength: 8,
                    minlength: 7
                },
                phone_number: {
                    maxlength: 12,
                    number: true
                },
                alt_phone_number: {
                    maxlength: 12,
                    number: true
                },
                email_address: {
                    maxlength: 255,
                    email: true
                },
                nationality: {
                    maxlength: 50,
                    required: true
                } 
            },
            messages: {
                first_name: {
                    required: "Tenant first name is required",
                    minlength: "Tenant first name must be at least 3 characters",
                    maxlength: "Tenant first length should not exceed 30 characters"
                },
                last_name: {
                    required: "Tenant last name is required",
                    minlength: "Tenant last name must be at least 3 characters",
                    maxlength: "Tenant last length should not exceed 30 characters"
                },
                id_number: {
                    maxlength:"ID No should contain a maximum 8 characters",
					minlength:"ID No should contain at least 7 characters"
                },
                phone_number: {
                    maxlength: "Phone Number length should not exceed 12 characters",
                    number: "Provide correct phone number ie 0712345678"
                },
                alt_phone_number: {
                    maxlength: "Phone Number length should not exceed 12 characters",
                    number: "Provide correct phone number ie 0712345678"
                },
                email_address: {
                    maxlength: "Provide a correct email address",
                    email: "Provide a correct email address"
                },
                nationality: {
                    maxlength: "Nationality should not exceed 50 charaters",
                    required: "Provide the tenant's nationalitys"
                } 
            }
        });


   

        $("#frm_new_tenant").on("submit", function(e) {
    e.preventDefault();
    var isvalid = $("#frm_new_tenant").valid();

    if (isvalid) {
        makeBusy('#frm_new_tenant');
         var data = new myFormData($(this));
        $.ajax({
            type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
            url: "<%=base_url%>/agent/properties/new-tenant",
            data: data,
            success: function(data) {
                makeBusy('#frm_new_tenant', 0);
                if (data.Status == 200) {
                    showAppNotification('success', data.Message);
                    loadPage("<%=base_url %>/agent/properties/<%=property.property_code%>?dest=tenants", true);
                } else {
                    showAppNotification('warning', data.Message);
                }
            },
            error: function(err) {
                makeBusy('#frm_new_tenant', 0);
                showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
            }
        });
    }
});

$("#btn_save_tenant").click(function() {
    var deps = $('#tbl_contacts').tableToJSON({
        columns: new Array(0, 1, 2)
    });
    $("#next_of_kins").val(JSON.stringify(deps));
    $("#frm_new_tenant").submit();
});


    });


</script>

<% if(!load_chunk){%> </body></html> <%}%>