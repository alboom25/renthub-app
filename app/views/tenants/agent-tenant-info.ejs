<% if(!load_chunk){%> 
  <%- include('../shared/page-header') %>
  <%- include('../shared/top-page') %>
  <div class="page-content">
<%}%>

<div class="container-fluid">
  <!-- start page title -->
  <div class="row">
     <div class="col-12">
        <div class="page-title-box d-flex align-items-center justify-content-between">
           <h4 id="page-title" class="mb-0 font-size-18"><%=page_title%></h4>
           <div class="page-title-right">
              <ol class="breadcrumb m-0">
                 <li class="breadcrumb-item"><a class='dynamic-link' href="<%= base_url %>">Home</a></li>
                 <li class="breadcrumb-item"><a class='dynamic-link' href="<%=base_url %>/agent/properties/<%=property.property_code%>?dest=tenants">Tenants</a></li>
                 <li class="breadcrumb-item active"><%=sub_header%></li>
              </ol>
           </div>
        </div>
     </div>
     <div class='col-12'>
     </div>
  </div>
  <!-- end page title -->
  <div class="row">
     <div class="col-xl-4">
        <div class="card overflow-hidden">
           <div class="bg-soft-primary">
              <div class="row">
                 <div class="col-12">
                    <div class="text-info p-3">
                       <h5 class="text-primary"><%= tenant_info.first_name +' '+ tenant_info.last_name%></h5>
                       <p></p>
                    </div>
                 </div>
              </div>
           </div>
           <div class="card-body pt-0">
              <div class="row">
                 <div class="col-sm-4">
                    <div class="avatar-md profile-user-wid mb-4">                     
                        <img src="<%=base_url%>/agent/properties/tenants/image/<%=tenant_info.tenant_id%>?property=<%=property.property_code%>" alt="" class="img-thumbnail rounded-circle" onclick="intitImagePopup(this)" title="Profile Image"/> 

                      
                    </div>
                    <h5 class="font-size-15">Reg. Date</h5>
                    <p class="text-muted mb-0"><%= new Intl.DateTimeFormat('en-GB', { dateStyle: 'full'}).format(tenant_info.created_on)%></p>
                 </div>
                 <div class="col-sm-8">
                    <div class="pt-4">
                       <div class="row">
                          <div class="col-12">
                             <p class="text-muted mb-0">Outstanding Balance</p>
                             <h5 id="lbl-balance" class="font-size-15 text-danger">0.00</h5>                             
                          </div>                          
                          <div class="col-12 border-top">
                             <p class="text-muted mb-0">Amount Paid To Date</p>
                             <h5 id="lbl-paid-amount" class="font-size-15">0.00</h5>                          
                          </div>
                          <div class="col-12 border-top">
                           <p class="text-muted mb-0">Excess Payments</p>
                           <h5 id="lbl-excess" class="font-size-15 text-primary">0.00</h5>                             
                        </div>
                       </div>
                       <div class="mt-2">
                          <button type="button" class="btn btn-info  btn-sm mt-1" data-toggle="modal" data-target="#mdl_send_sms" >Send SMS Message</button>
                          <a href="<%= base_url %>/agent/properties/tenants/edit/<%=tenant_info.tenant_id%>?property=<%=property.property_code%>" class="btn btn-warning  btn-sm mt-1 dynamic-link"><i class='bx bxs-edit'></i> Edit Tenant</a>
                       </div>
                    </div>
                 </div>
              </div>
           </div>
        </div>
        <!-- end card -->
        <div class="card">
           <div class="card-body">
              <h4 class="card-title mb-4">Personal Information</h4>
              <div class="table-responsive">
                 <table class="table mb-0" style="width:100%">
                    <tbody>
                       <tr>
                          <th scope="row">Gender :</th>
                          <td><%=tenant_info.gender%></td>
                       </tr>
                       <tr>
                          <th scope="row">Full Name :</th>
                          <td><%=tenant_info.first_name +' ' + tenant_info.last_name%></td>
                       </tr>
                       <tr>
                          <th scope="row">Nationality :</th>
                          <td><%=tenant_info.nationality%></td>
                       </tr>
                       <tr>
                          <th scope="row">ID NO :</th>
                          <td><%=tenant_info.id_number%></td>
                       </tr>
                       <tr>
                          <th scope="row">Mobile :</th>
                          <td><% if(tenant_info.phone_number.length>6){%>
                           <a href="tel:<%=tenant_info.phone_number%>" class="btn btn-light btn-sm btn-rounded"  data-toggle="tooltip" data-placement="top" title="" data-original-title="Click to call"><%=tenant_info.phone_number%></a>
                          <%}else{%>
                           <%=tenant_info.phone_number%>
                          <%} %> 
                           </td>
                       </tr>
                       <tr>
                          <th scope="row">Alt. Mobile :</th>
                          <td><%=tenant_info.alt_phone_number%></td>
                       </tr>
                       <tr>
                          <th scope="row">E-mail :</th>                       
                          <td><% if(tenant_info.email_address.length>6){%>
                           <a href="mailto:<%=tenant_info.email_address%>" class="btn btn-light btn-sm btn-rounded" data-toggle="tooltip" data-placement="top" title="" data-original-title="Click to send an email"><%=tenant_info.email_address%></a>
                          <%}else{%>
                           <%=tenant_info.email_address%>
                          <%} %> 
                           </td>
                       </tr>
                    </tbody>
                 </table>
              </div>
           </div>
        </div>
         <!-- end card -->   
       
     </div>
     <div class="col-xl-8">
        <div class="row">
           <div class="col-md-4">
              <div class="card mini-stats-wid">
                 <div class="card-body">
                    <div class="media">
                       <div class="media-body">
                          <p class="text-muted font-weight-medium">Paid Invoices</p>
                          <h4 id="lbl-paid-invoices" class="mb-0">0</h4>
                       </div>
                       <div class="mini-stat-icon avatar-sm align-self-center rounded-circle bg-warning">
                          <span class="avatar-title bg-success">
                          <i class="bx bx-check-circle font-size-24"></i>
                          </span>
                       </div>
                    </div>
                 </div>
              </div>
           </div>
           <div class="col-md-4">
              <div class="card mini-stats-wid">
                 <div class="card-body">
                    <div class="media">
                       <div class="media-body">
                          <p class="text-muted font-weight-medium">Pending Invoices</p>
                          <h4 id="lbl-pending-invoices" class="mb-0">0</h4>
                       </div>
                       <div class="avatar-sm align-self-center mini-stat-icon rounded-circle ">
                          <span class="avatar-title bg-warning">
                          <i class="bx bx-hourglass font-size-24"></i>
                          </span>
                       </div>
                    </div>
                 </div>
              </div>
           </div>
           <div class="col-md-4">
              <div class="card mini-stats-wid">
                 <div class="card-body">
                    <div class="media">
                       <div class="media-body">
                          <p class="text-muted font-weight-medium">Cancelled Invoices</p>
                          <h4 id="lbl-cancelled-invoices" class="mb-0">0</h4>
                       </div>
                       <div class="avatar-sm align-self-center mini-stat-icon rounded-circle bg-primary">
                          <span class="avatar-title bg-danger">                                        
                          <i class='bx bxs-file font-size-24'></i>
                          </span>
                       </div>
                    </div>
                 </div>
              </div>
           </div>
        </div>
        <div class="card">
         <div class="card-body">
            <h4 class="card-title">Documents</h4>
            <div class="row">
               <div class='col-md-6'>
                  <label>Id Back</label>                     
                     <img  onclick="intitImagePopup(this)" class="rounded mb-4" alt="" width="100%" src="<%=base_url%>/agent/properties/tenants/front-id/<%=tenant_info.tenant_id%>?property=<%=property.property_code%>" title="ID Front" />
               </div>

               <div class='col-md-6'>
                  <label>Id Front</label> 
                  <img class="rounded" onclick="intitImagePopup(this)" title="ID Back" alt="" width="100%" src="<%=base_url%>/agent/properties/tenants/back-id/<%=tenant_info.tenant_id%>?property=<%=property.property_code%>"/>
               </div>
            </div>
               
         </div>
      </div>
      <!-- end card -->

        <div class="card">
           <div class="card-body">
              <h4 class="card-title mb-4">Emergency Contacts</h4>
              <table id="tbl_contacts" class="table dt-responsive table-nowrap table-hover mb-0" style="width:100%">
                 <thead>
                    <tr>
                       <th>Name</th>
                       <th>Relationship</th>
                       <th>Contact(s)</th>
                    </tr>
                 </thead>
                 <tbody>
                    <%
                       var contacts = JSON.parse(tenant_info.next_of_kins);
                       for(var i=0; i< contacts.length; i++){%>
                    <tr>
                       <td><%= contacts[i]["Name"]%></td>
                       <td><%= contacts[i]["Relationship"]%></td>
                       <td><%= contacts[i]["Phone Number"]%></td>
                    </tr>
                    <%}%>
                 </tbody>
              </table>
           </div>
        </div> 
     </div>
  </div>

</div>
<!-- container-fluid -->
  <% if(!load_chunk){%> </div> <%- include('../shared/page-footer') %> <%- include('../shared/admin-scripts') %> <%}%>

<!-- send sms -->
<div id="mdl_send_sms" class="modal fade" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
     <!-- Modal content-->
     <div class="modal-content">
        <div class="modal-header">
           <h5 class="modal-title">Send SMS</h5>
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
           <i class='bx bx-x'></i>
           </button>
        </div>
        <form id='frm_tenant_sms' method='post' action='#'>
           <input type="hidden" name="tenant_id" value="<%=tenant_info.tenant_id%>"/>
           <input type="hidden" name="property" value="<%=property.property_code%>"/>
           <div class="modal-body">
              <div class="form-group row mb-0">
                 <div class="col-12">    
                    <label for="sms_message">Message <span class="text-danger">*</span></label>         
                    <textarea class="form-control" name='sms_message' rows="5"></textarea>			
                 </div>
              </div>
           </div>
           <div class="modal-footer"> 
              <button type="submit" id="btn_send_sms" class="btn btn-success">Send SMS</button>          
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
           </div>
        </form>
     </div>
  </div>
</div>

<script>
   window.onload=function(){window.jQuery||window.location.reload()};
 

$(document).ready(function(e){
   $('.selectpicker-select').selectpicker();

   $("#tbl_invoice_particulars").SetEditable({
                columnsEd: "0, 1",   
                onEdit: function() {computeBill()},
                onDelete:  function() {computeBill()},
               $addButton: $("#add_particular"),
            });
            $("#tbl_other_bills").SetEditable({
					autoDelete: false,
					columnsEd: "0, 1",				
					$addButton: $("#add_other_bill"),
				});

  
        $("#frm_tenant_sms").validate({
    rules:{
      sms_message: {
        required: true,
        maxlength: 320,
        minlength: 20
      }
    },
    messages:{
    sms_message: {
        required: "Empty SMS message not allowed",
        maxlength: "SMS message limited to 320 characters",
        minlength: "SMS message should have at least 20 characters"
      }
    }
  });
  
  $("#frm_add_payment").validate({ 
    rules:{ 
      bill_id:{
			required: true,
			remote: "<%= base_url %>/accounting/tenant-invoices/bill-available"
		},
      payment_date:{
        required: true,
        date:true
      },
      payment_method:{
        required: true
      },
      payment_amount:{
        required: true,
        number: true,
        min: 10
      },
      payment_ref :{
        maxlength: 255
      },
      payment_by:{
        maxlength: 255
      }
    },
    messages:{ 
      bill_id: {
			required: "Please enter the invoice number",
			remote:"The invoice number does not exist in the system."
		},
      payment_date:{
        required: "Please click to select payment date",
        date:"Invalid date value"
      },
      payment_method:{
        required: "Invalid payment method"
      },
      payment_amount:{
        required: "Please enter the paid amount",
        number: "Please enter the paid amount",
        min: "Amount should be greater than 10"
      },
      payment_ref :{
        maxlength: "Maximum length required is 255 characters"
      },
      payment_by:{
        maxlength: "Maximum length required is 255 characters"
      }
    }
  });

      
    //$("#tbl_contacts").DataTable({responsive: !0, search: false, info:false});
    
	$("#tbl_leases").DataTable({
    responsive: !0,
    searchDelay: 500,
   processing: !0,
         serverSide: true,
    order: [],
    ajax: {
      url:
        "<%= base_url %>/agent/properties/tenant-leases",
      type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
      data:{
        "tenant_id":"<%=tenant_info.tenant_id%>","property":"<%=property.property_code%>"
      }
    },
    columns: [    
      {
        data: "lease_date"
       
      },
      {
        data: "expiry_date"
       
      },
      {
        data: null,
        render: function(data, type, row){
            if(data.expired){
               return "<span class='badge badge-danger'>Expired</span>";            
            }else{
               if(data.expiry_date===null){
                  return "<span class='badge badge-success'>Active</span>";
                }else{
                  return "<span class='badge badge-warning'>Expiring Soon</span>";
                }     
            }
        },
      },
      {
        data: null,
        render: function(data, type, row){
            return "<a href='<%= base_url %>/manage/units/info/"+ data.unit_code+"' class='dynamic-link text-info'>"+ data.unit_name +", " + floorToLabel(data.floor) +"</a>";
        },
      },
      {
        data: "bills_payment_date",
      }, 
      {
          data: null,
          responsivePriority: -1,
          render: function(data, type, row){  
             return tenancyData(data);          
          }
      }     
        
     
    ],
  });
 
  $("#tbl_invoices").DataTable({
    responsive: !0,
    searchDelay: 500,
   processing: !0,
         serverSide: true,
    order: [],
    ajax: {
      url:
        "<%= base_url %>/agent/properties/tenant-tenant-invoices",
      type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
      data:{
        "tenant_id":"<%=tenant_info.tenant_id%>"
      }
    },
    columns: [    
      {
        data: "bill_date"
       
      },
      {
        data: "bill_code"
       
      },
      {
        data: "unit_name"
       
      },
      {
        data: null,
        className:"text-md-left, text-lg-right ",
        render: function(data, type, row){
            return formatMoney(data.total_amount);
        }
       
      },
      {
        data: null,
        className:"text-md-left, text-lg-right ",
        render: function(data, type, row){
            return formatMoney(data.total_amount - data.paid_amount);
        }
      }, 
      {
          data: null,
          render: function(data, row, type) {
            var bal = data.total_amount - data.paid_amount;
            if(data.is_cancelled) {
              return '<span class="badge badge-danger">Cancelled</span>';
            } else if(bal > 0) {
              return '<span class="badge badge-warning">Uncleared</span>';
            } else {
              return '<span class="badge badge-success">Cleared</span>';
            }
          }
        },
      {
          data: null,
          responsivePriority: -1,
          render: function(data, type, row){
              return actionData(data);
          }
      }     
        
     
    ],
  });

  $("#tbl_payments").DataTable({
    responsive: !0,
    searchDelay: 500,
   processing: !0,
         serverSide: true,
    order: [],
    ajax: {
      url:
        "<%= base_url %>/agent/properties/tenant-tenant-payments",
      type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
      data:{
        "tenant_id":"<%=tenant_info.tenant_id%>"
      }
    },
    columns: [    
      {
        data: "payment_date"
       
      },
      {
        data: "bill_code"
       
      },
      {
        data: "payment_method"
       
      },
      {
        data: "payment_ref"
       
      },
      {
        data: null,
        className:"text-md-left, text-lg-right ",
        render: function(data, type, row){
            return formatMoney(data.payment_amount);
        }
       
      },   
      {
			data: null,
			render: function(data, type, row) {
            var rp = '<span class="badge badge-soft-success">Completed</span>';
				if(data.is_cancelled) {
					rp = '<a class=" btn badge badge-soft-danger" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="a'+data.payment_id+'" href="#a'+data.payment_id+'" >Cancelled</a><div id="a'+data.payment_id+'" class="collapse mt-2 text-wrap alert alert-danger"><b>Reasons:</b> '+data.cancel_reasons +'</div>';
					
				}
				return rp;
			},
		},   
      {
          data: null,
          responsivePriority: -1,
          render: function(data, type, row){
              return paymentData(data);
          }
      }     
        
     
    ],
  });
loadBalances();

        $("#frm_tenant_sms").submit(function(e){
  e.preventDefault();
  var valid = $("#frm_tenant_sms").valid();
  if(valid){
    $('#btn_send_sms').html('Please wait..');
        $("#btn_send_sms").attr("disabled", true);
         var data = new myFormData($(this));
        $.ajax({
            type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
            url: "<%= base_url %>/agent/properties/tenants/send-sms",
            data: data,
            success: function(data) {
                $('#btn_send_sms').html('Send SMS');
                $("#btn_send_sms").attr("disabled", false);
                if (data.Status == 200) {
                  $("#mdl_send_sms").modal("hide"); 
                  
                  showAppNotification('success', data.Message);
                } else {
                    showAppNotification('warning', data.Message);
                }
            },
            error: function(err) {
              $('#btn_send_sms').html('Send SMS');
                $("#btn_send_sms").attr("disabled", false);
                showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
            }
        });
    
  }

});

$("#frm_add_payment").on("submit", function(e) {
        e.preventDefault();
         var isvalid = $("#frm_add_payment").valid();
         if (isvalid) {
        $('#btn_add_payment').html('Please wait..');
        $("#btn_add_payment").attr("disabled", true);
         var data = new myFormData($(this));
        $.ajax({
            type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
            url: "<%= base_url %>/accounting/tenant-invoices/add-payment",
            data: data,
            success: function(data) {
                $('#btn_add_payment').html('Add Payment');
                $("#btn_add_payment").attr("disabled", false);
                if (data.Status == 200) {
                  $("#mdl_add_payment").modal("hide");
                  $("#tbl_invoices").DataTable().ajax.reload();
                  $("#tbl_payments").DataTable().ajax.reload();
                  loadBalances();
                  showAppNotification('success', data.Message);
                } else {
                    showAppNotification('warning', data.Message);
                }
            },
            error: function(err) {
                $('#btn_add_payment').html('Add Payment');
                $("#btn_add_payment").attr("disabled", false);
                showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
            }
        });
    
      }
});
    
$("#btn_update_changes").click(function(e){
  e.preventDefault();
  var pats = $("#tbl_invoice_particulars").tableToJSON({
		columns: new Array(0, 1),
  });	
  var obj ={
    bill_particulars: pats,
    bill_id: $("#edit_invoice_id").val()
  }
  $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/accounting/tenant-invoices/update-invoice",
        data: obj,        
        success: function(data) {
         
          if (data.Status == 200) {
            $("#mdl_edit_invoice").modal("hide")
            showAppNotification("success", data.Message);
            $("#tbl_invoices").DataTable().ajax.reload();
            loadBalances();
          } else {
            showAppNotification("warning", data.Message);
          }
        },
        error: function(err) {
         showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
        }
      });
  

});

$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      $($.fn.dataTable.tables(true)).DataTable()
      .columns.adjust()
      .responsive.recalc();
  });  
});

function tenancyData(data){
   var btns = '<a class="dropdown-item" href="javascript:void(0)" onclick=\'previewTenancy("' + data.lease_id + '")\'>Preview Tenancy</a>';
   if(!data.expired){
      btns +='<a onclick="editTenancy(\''+ data.lease_id +'\')" class="dropdown-item text-info" href="javascript:void(0);">Edit Tenancy</a>';
      btns +='<a onclick="terminateTenancy(\''+ data.lease_id +'\')" class="dropdown-item text-warning" href="javascript:void(0);">Terminate Tenancy</a>';  
   }
   return row_begin + btns + row_end;
}

function loadBalances(){
  
  $.ajax({
            type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
            url: "<%= base_url %>/agent/properties/tenant-accounts-info",
            data: "tenant_id=<%=tenant_info.tenant_id%>",
            success: function(data) {
                if(data.data){
                    $("#lbl-paid-invoices").html(data.data.completed_invoices);
                    $("#lbl-pending-invoices").html(data.data.pending_invoices);
                    $("#lbl-cancelled-invoices").html(data.data.cancelled_invoices);                    
                    $("#lbl-excess").html(formatMoney(data.data.excess_amount));
                    $("#lbl-paid-amount").html(formatMoney(data.data.paid_amount));
                    $("#lbl-balance").html(formatMoney(data.data.balance));                  
                }
                
            },
            error: function(err) {            
                showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
            }
        });
    
}

function paymentData(data){
  var btns = '';
      if(data.is_cancelled) {
        btns = `<a class="dropdown-item" href="javascript:void(0)" onclick='previewInvoice("${data.bill_id}")'>Preview Bill</a>`;
      } else {
		btns = `<a class="dropdown-item" href="javascript:void(0)" onclick='previewInvoice("${data.bill_id} ")'>Preview Bill</a><a class="dropdown-item" href="javascript:void(0)" onclick='cancelPayment("${data.payment_id}")'>Cancel Payment</a>`;
      }
      return row_begin + btns + row_end;
}

function actionData(data) {
      var bal = data.total_amount - data.paid_amount;
      var btns = '';
      if(data.is_cancelled) {
        btns = `<a class="dropdown-item" href="javascript:void(0)" onclick='previewInvoice("${data.bill_id}")'>Preview</a><a class="dropdown-item" href="javascript:void(0)" onclick='downloadPdfInvoice("<%=base_url %>/accounting/tenant-invoices/download-invoice/${data.bill_id}")'>Download</a>`;
      } else {
        if(bal > 0) {
          if(data.paid_amount > 0) {
            btns = `<a class="dropdown-item" href="javascript:void(0)" onclick='previewInvoice("${data.bill_id}")'>Preview</a><a class="dropdown-item" href="javascript:void(0)" onclick='downloadPdfInvoice("<%=base_url %>/accounting/tenant-invoices/download-invoice/${data.bill_id}")'>Download</a><a class="dropdown-item" href="javascript:void(0)" onclick='cancelInvoice("${data.bill_id}")'>Cancel</a><a class="dropdown-item" href="javascript:void(0)" onclick='editInvoice("${data.bill_id}")'>Edit</a><a class="dropdown-item" href="javascript:void(0)" onclick='addPayment("${data.bill_id}")'>Add Payment</a>`;
          } else {
            btns = `<a class="dropdown-item" href="javascript:void(0)" onclick='previewInvoice("${data.bill_id}")'>Preview</a><a class="dropdown-item" href="javascript:void(0)" onclick='downloadPdfInvoice("<%=base_url %>/accounting/tenant-invoices/download-invoice/${data.bill_id}")'>Download</a><a class="dropdown-item" href="javascript:void(0)" onclick='cancelInvoice("${data.bill_id}")'>Cancel</a><a class="dropdown-item" href="javascript:void(0)" onclick='editInvoice("${data.bill_id}")'>Edit</a><a class="dropdown-item" href="javascript:void(0)" onclick='addPayment("${data.bill_id}")'>Add Payment</a><a class="dropdown-item text-danger" href="javascript:void(0)" onclick='deleteInvoice("${data.bill_id}")'>Delete</a>`;
          }
        } else {
          btns = `<a class="dropdown-item" href="javascript:void(0)" onclick='previewInvoice("${data.bill_id}")'>Preview</a><a class="dropdown-item" href="javascript:void(0)" onclick=\'downloadPdfInvoice("<%=base_url %>/accounting/tenant-invoices/download-invoice/${data.bill_id}")'>Download</a>`;
        }
      }
      return row_begin + btns + row_end;
    }

    function previewInvoice(id) {
      $("#preview_invoice_body").html(loading_div);
      $("#mdl_preview_invoice .modal-footer").html('<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>');
      $("#mdl_preview_invoice").modal('show');
      $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/accounting/tenant-invoices/invoice-info",
        data: 'bill_id=' + id,
        success: function(data) {
          if(data.data) {
            var part1 = invoiceData(data.data);           
            $("#preview_invoice_body").html(part1);
            $("#mdl_preview_invoice .modal-footer").html('<button type="button" class="btn btn-success" onclick="downloadPdfInvoice(\'<%=base_url %>/accounting/tenant-invoices/download-invoice/' + data.data.bill_code + '\')">Download</button><button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>');
          } else {
            var resp = '<div class="alert alert-warning fade show"><divclass="alert-text">' + data.Message + '</div></div>';
            $("#preview_invoice_body").html(resp);
          }
        },
        error: function(err) {
          var resp = '<div class="alert alert-danger fade show"><divclass="alert-text">An error occured while getting invoice details! Please try again.</div></div>';
          $("#preview_invoice_body").html(resp);
        }
      });
    }
    
   function cancelPayment(id) {	
	 sharpAlert({
		title: 'Confirm?',
		text: "Are you sure you want to cancel the payment?",
		type: 'warning',
		showCancelButton: true,
		confirmButtonText: 'Yes',
		confirmButtonClass: "btn btn-success mr-2 btn-swal",
		cancelButtonText: 'No',
		cancelButtonClass: "btn btn-danger mr-2 btn-swal",
		reverseButtons: true,
		buttonsStyling: false
	},(passed)=>{
		 if (passed) {
			$("#cancel-payment-id").val(id);
	$("#cancel-reasons").val("");
	$("#cancel-payment-modal").modal('show');
	$("#cancel-reasons").focus();
		}
	});
}

$("#cancel-payment-button").click(function(e){
    var id=$("#cancel-payment-id").val();	
    var reasons = $("#cancel-reasons").val();
	
    if(id && reasons.length > 3) {
        $.ajax({
            type: "POST",
                async: true, 
            credentials: 'same-origin',
            headers: {
                'CSRF-Token': csrf_token
            },
            url: "<%= base_url %>/accounting/tenant-payments/cancel",
            data: {"id": id, "reasons":reasons},
            success: function(data) {
                if(data.Status == 200) {
                     $("#cancel-payment-modal").modal('hide');
                     showAppNotification("success", data.Message);                         
                     $("#tbl_payments").DataTable().ajax.reload();
                     $("#tbl_invoices").DataTable().ajax.reload();
                     loadBalances();                   
                } else {
                    showAppNotification('warning', data.Message);
                }
            },
            error: function(err) {				
                showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
            },
        });
    }else{
        $("#cancel-reasons").focus();
        showAppNotification('warning', "Please provide cancel reasons");
    }


});
    
    function cancelInvoice(id) {
 sharpAlert({
  title: 'Confirm?',
  text: "Are you sure you want to cancel this invoice?",
  type: 'warning',
  showCancelButton: true,
  confirmButtonText: 'Yes',
  confirmButtonClass:"btn btn-success mr-2 btn-swal",
  cancelButtonText: 'No',
  cancelButtonClass:"btn btn-danger mr-2 btn-swal",
 
  buttonsStyling: false
},(passed)=>{
  if (passed) {
    $.ajax({
		type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
		url: "<%= base_url %>/accounting/tenant-invoices/cancel",
		data: "invoice_id="+id,
		success: function(data) {
			$("#tbl_invoices").DataTable().ajax.reload();
      loadBalances();
			if (data.Status == 200) {
				showAppNotification("success", data.Message);
			} else {
				showAppNotification("warning", data.Message);
			}
		},
		error: function(err) {
			showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');		
		},
  });
  
    
  } 
});
      
    }
    
    function editInvoice(id) {
      $("#tbl_invoice_particulars tbody").html('');
      $("#edit_invoice_title").html('Edit Invoice (Loading...)');
      $("#btn_update_changes").attr("disabled", true);
      $("#add_particular").attr("disabled", true);
     
      $("#mdl_edit_invoice").modal('show');
     
      $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/accounting/tenant-invoices/invoice-info",
        data: 'bill_id=' + id,
        success: function(data) {
          if(data.data) {
            var invoice_info = data.data;
            $("#btn_update_changes").attr("disabled", false);
            $("#add_particular").attr("disabled", false); 
            $("#edit_invoice_id").val(invoice_info.bill_id);
            $("#edit_invoice_title").html('Edit Invoice (' + invoice_info.bill_code +")");

            var bills = JSON.parse(invoice_info.bills_breakdown);
            var total =0;
            for(var i = 0; i < bills.length; i++) {
              var row = '<tr><td>' + bills[i].bill_name + '</td><td class="text-right">' + bills[i].bill_amount + '</td>' + colEdicHtml +'</tr>';
              $("#tbl_invoice_particulars tbody").append(row);
              total += bills[i].bill_amount;
            }          
            $("#bill_total").html("Total " + formatMoney(total));
          } else {
            $("#mdl_edit_invoice").modal('hide');
            showAppNotification('warning', data.Message);
          }
        },
        error: function(err) {
          $("#mdl_edit_invoice").modal('hide');
          showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
        }
      });
    }

    function computeBill() {
	
	var deps = $("#tbl_invoice_particulars").tableToJSON({
		columns: new Array(0, 1),
  });	
    var total = 0;
    
    for(var i = 0; i < deps.length; i++) {			
			var t = parseInt(deps[i]["Amount"]) || 0;
      total +=t;
      
			
    }
    $("#bill_total").html("Total " + formatMoney(total));
	
}
     
    function deleteInvoice(id) {
      sharpAlert({
  title: 'Confirm?',
  text: "Are you sure you want to delete this invoice?",
  type: 'warning',
  showCancelButton: true,
  confirmButtonText: 'Yes',
  confirmButtonClass:"btn btn-success mr-2 btn-swal",
  cancelButtonText: 'No',
  cancelButtonClass:"btn btn-danger mr-2 btn-swal",
 
  buttonsStyling: false
},(passed)=>{
  if (passed) {
    $.ajax({
		type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
		url: "<%= base_url %>/accounting/tenant-invoices/delete",
		data: "invoice_id="+id,
		success: function(data) {     
			$("#tbl_invoices").DataTable().ajax.reload();
      loadBalances();
			if (data.Status == 200) {
				showAppNotification("success", data.Message);
			} else {
				showAppNotification("warning", data.Message);
			}
		},
		error: function(err) {
			showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');		
		},
  });
  
    
  } 
})
    }
    
    function addPayment(id) {
      $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/accounting/tenant-invoices/invoice-info",
        data: 'bill_id=' + id,
        success: function(data) {
          if(data.data) {
            var invoice_info = data.data;
            
            var balance  = invoice_info.total_amount - invoice_info.paid_amount;
            if(balance>0){
              $("#frm_add_payment").trigger('reset');
              setTodayDate();
              $("#payment_bill_id").val(id);
              $("#add_payment_title").html("Add Payment (" + invoice_info.bill_code +")");
              $("#payment_payment_amount").val(balance);
              $("#payment_payment_by").val(invoice_info.first_name + " "  + invoice_info.last_name);
              $("#mdl_add_payment").modal("show");

            }else{
              showAppNotification('warning', "This invoice has already been paid up");
            }
          
          } else {
            showAppNotification('warning', data.Message);
          }
        },
        error: function(err) {
          showAppNotification('warning', 'An error occured while getting invoice details! Please try again.');
        }
      });
  }
  
  function setTodayDate(){
      $('#payment_payment_date').val(todaysDate());
   }

   function editTenancy(id){
      $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/manage/leases/get-single",
        data: {id:id},        
        success: function(data) {         
          if (data.Status == 200) {
           var data = data.Message;
           if(data.expiry_date===null){
            
            $("#tbl_other_bills tbody").html('');
          
				var bills = JSON.parse(data.fixed_monthly_bills);
				for(var i = 0; i < bills.length; i++) {
					var row = "<tr><td>" + bills[i]["Bill Name"] + "</td><td class='text-right'>" + bills[i]["Amount"] + "</td>" + colEdicHtml +"</tr>";
					$("#tbl_other_bills tbody").append(row);
				}

            initDates(data.bills_payment_date);
            $("#monthly_rent").val(data.monthly_rent);
            $("#mdl_edit_lease .modal-title").html('Edit Lease ('+ data.unit_name +', '+ floorToLabel(data.floor) +')');
            $("#mdl_edit_lease .modal-footer").html('<button type="button" onclick="saveLeaseEdits()" class="btn btn-success" ">Save Changes</button><button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>');
            $("#edit_lease_id").val(id);

            $("#mdl_edit_lease").modal("show");

           }else{
              showAppNotification('warning',"Cannot edit this lease. Already terminated!")
           }
          } else {
           showAppNotification('warning', data.Message);
          }
        },
        error: function(err) {        
         showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
        }
      });
   }

   function initDates(current_date) {
	var y = 31;
	var x = 0;
	var options = [];
	while(x < y) {
		x++;
		var val = '<option value="' + x + '">' + x + "</option>";
		if(x == current_date) {
			var val = '<option  selected="selected" value="' + x + '">' + x + "</option>";
		}
		options.push(val);
	}
	$("#payment_date").html(options.join(""));
}

function saveLeaseEdits(){
   $("#mdl_edit_lease").modal('hide');
   var bills = $("#tbl_other_bills").tableToJSON({
		columns: new Array(0, 1),
	});
   $("#unit_fixed_bills").val(JSON.stringify(bills));
   var form_data = $("#frm_edit_lease").serialize();
   $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/manage/leases/edit",
        data: form_data,        
        success: function(data) {         
          if (data.Status == 200) {
             showAppNotification("success", data.Message);
             $("#tbl_leases").DataTable().ajax.reload();            
          } else {
            $("#mdl_edit_lease").modal('show');
            showAppNotification('warning', data.Message);          
          }
        },
        error: function(err) {       
         $("#mdl_edit_lease").modal('show'); 
          showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
        }
      });
   }
  
    function terminateTenancy(id){
      $("#mdl_terminate_tenancy .modal-body").html(loading_div);
      $("#mdl_terminate_tenancy .modal-footer").html('<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>');
      $("#mdl_terminate_tenancy .modal-title").html('Tenancy Termination');
      $("#mdl_terminate_tenancy").modal("show");
      $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/manage/leases/get-single",
        data: {id:id},        
        success: function(data) {         
          if (data.Status == 200) {
             var data = data.Message;
            $("#mdl_terminate_tenancy .modal-footer").html('<button type="button" onclick="proceedTermination()" class="btn btn-success" ">Proceed</button><button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>');

            $("#mdl_terminate_tenancy .modal-title").html('Lease Termination ('+ data.unit_name +', '+ floorToLabel(data.floor) +')');
          
             var resp = '<div class="row"> <div class="col-12"> <form class="form-horizontal" action="#" method="post" id="frm_terminate_tenancy"> <div class="form-group row"> <label for="termination_date" class="col-md-5 col-form-label">Expected move out date</label> <div class="col-md-7"> <input type="date" class="form-control" id="termination_date" name="termination_date" required> </div> </div> <input type="hidden" name="lease_id" value="'+id+'"/> </form> <label for="form-label">Available deposit(s)</label> <table class="table border table-bordered mb-0"> <tbody>';
               var deps = JSON.parse(data.deposists);
               var deps_str ='';
               for(var i = 0; i < deps.length; i++) {
                  deps_str+='<tr> <th scrope="row">'+ deps[i]["Deposit Name"]+'</th> <td class="text-right">'+ formatMoney(deps[i]["Amount"])+'</td> </tr>';
               }
               resp +=deps_str;
            resp +='</tbody> </table></div> </div>';
            $("#mdl_terminate_tenancy .modal-body").html(resp);
            var now = moment().format();
            var day = ("0" + parseInt(data.bills_payment_date-1).toString()).slice(-2);
            var month = ("0" + (now.getMonth() + 1)).slice(-2);
            var td = now.getFullYear()+"-"+(month)+"-"+(day);
           
            var xd = new Date(td);
            if(now.getTime()>xd.getTime()){
               var month = ("0" + (now.getMonth() + 2)).slice(-2);
               var td = now.getFullYear()+"-"+(month)+"-"+(day);               
            }
            $("#termination_date").val(td)
            
          } else {
            var resp = '<div class="alert alert-warning fade show"><divclass="alert-text">' + data.Message + '</div></div>';
            $("#preview_tenancy_body").html(resp);
          }
        },
        error: function(err) {        
          var resp = '<div class="alert alert-danger fade show"><divclass="alert-text">An error occured while getting invoice details! Please try again.</div></div>';
          $("#preview_tenancy_body").html(resp);
        }
      });
   }

   function proceedTermination(){
      var form_data = $('#frm_terminate_tenancy').serialize(); 
      $("#mdl_terminate_tenancy").modal('hide');
      $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/manage/leases/terminate",
        data: form_data,        
        success: function(data) {         
          if (data.Status == 200) {
             showAppNotification("success", data.Message);
             $("#tbl_leases").DataTable().ajax.reload();
             getPendingTerminations();
          } else {
            $("#mdl_terminate_tenancy").modal('show');
            showAppNotification('warning', data.Message);          
          }
        },
        error: function(err) {       
         $("#mdl_terminate_tenancy").modal('show'); 
          showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
        }
      });
   }
	
	function previewTenancy(id){
      $("#preview_tenancy_body").html(loading_div);
      $("#mdl_preview_tenancy").modal("show");
      $.ajax({
        type: "POST",
        async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
        url: "<%= base_url %>/manage/leases/get-single",
        data: {id:id},        
        success: function(data) {         
          if (data.Status == 200) {
             var resp = leaseData(data.Message);
            $("#preview_tenancy_body").html(resp);
          } else {
            var resp = '<div class="alert alert-warning fade show"><divclass="alert-text">' + data.Message + '</div></div>';
            $("#preview_tenancy_body").html(resp);
          }
        },
        error: function(err) {        
          var resp = '<div class="alert alert-danger fade show"><divclass="alert-text">An error occured while getting invoice details! Please try again.</div></div>';
          $("#preview_tenancy_body").html(resp);
        }
      });
   }

   function leaseData(data){    
      var str= '<div class="row"> <div class="col-12"> <div class="table-responsive"> <table class="table table-hover border mb-0"> <tbody> <tr> <th scope="row">Unit/Room:</th> <td><a href="<%= base_url %>/manage/units/info/'+ data.unit_code+'" class="dynamic-link text-info">'+ data.unit_name +', '+ floorToLabel(data.floor) +'</a></td> </tr> <tr> <th scope="row">Lease Date:</th> <td>'+ data.lease_date +'</td> </tr><tr> <th scope="row">Expiry Date:</th> <td>';
         if(data.expiry_date ==null){
            str+="<span class='badge badge-success'>Active</span>";
         }else{
            str +=data.expiry_date;
         }
         str +='</td> </tr> <tr> <th scope="row">Tenant Name:</th> <td>'+ data.tenant_name +'</td> </tr> <tr> <th scope="row">Leased By:</th> <td>'+ data.leased_by +'</td> </tr> <tr> <th scope="row">Monthly Rent:</th> <td>'+ formatMoney(data.monthly_rent) +'</td> </tr> <tr> <th scope="row">Deposits</th> <td> <table class="table table-sm table-borderless mb-0"> <tbody>';
      var deps = JSON.parse(data.deposists);
      var deps_str ='';
      for(var i = 0; i < deps.length; i++) {
         deps_str+='<tr> <td>'+ deps[i]["Deposit Name"]+':</td> <td class="text-right">'+ formatMoney(deps[i]["Amount"])+'</td> </tr>';
      }
      str +=deps_str;
         
      str +=  '</tbody> </table> </td> </tr> <tr> <th scope="row">Fixed Monthly Bills:</th> <td> <table class="table table-sm table-borderless mb-0"> <tbody>';

      var fixed_bills = JSON.parse(data.fixed_monthly_bills);
      var fs_str ='';
      for(var i = 0; i < fixed_bills.length; i++) {
         fs_str +='<tr> <td>'+ fixed_bills[i]["Bill Name"]+':</td> <td class="text-right">'+ formatMoney(fixed_bills[i]["Amount"])+'</td> </tr>';
      }
      str +=fs_str;

      str +='</tbody> </table> </td> </tr> <tr> <th scope="row">Payments Date:</th> <td>'+ data.bills_payment_date +'</td> </tr> <tr> <th scope="row">Lease Agreement:</th> <td>';
         if(data.lease_agreement_path !==null){
            str +='<a onclick="downloadLeaseFile(\''+ data.lease_agreement_path +'\')" href="javascript: void(0);" class="btn btn-sm btn-light text-dark font-weight-medium">'
            if(data.file_extension==".pdf"){
               str +='<i class="bx bxs-file-pdf font-size-24 align-middle text-success mr-2"></i>';              
            }else{
               str+='<i class="bx bxs-image-alt font-size-24 align-middle text-success mr-2"></i>';
            }
            str+= data.lease_agreement_path  + '</a>';
         }
        str+='</td> </tr> </tbody> </table> </div> </div> </div>';
      return str;
   }

   function downloadLeaseFile(filename){     
    showAppNotification("info", "Your request has been generated. This can take few seconds.");
    fetch("<%= base_url %>/manage/leases/lease-file/"+filename)
         .then(resp => resp.blob())
         .then(blob => { 
            if(blob.type=="text/html; charset=utf-8" || blob.type=="text/html" || blob.type==""){
               showAppNotification("danger", "Unable to generate the file. Please refresh and try again");
            }else{
               const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showAppNotification("success", "Lease agreement file has been generated");
            }
           
        })
        .catch(() => {
            showAppNotification("warning", "Unable to generate file. Please try again!");
        });
   }


</script>
<% if(!load_chunk){%> </body></html> <%}%>