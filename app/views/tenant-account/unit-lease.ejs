<% if(!load_chunk){%> 
  <%- include('../shared/page-header') %>
  <%- include('../shared/top-page') %>
  <div class="page-content">
     <%}%>
     <div class="container-fluid">
        <%- include('../shared/page-title') %>
        <div class="row">
           <div class="col-lg-12">
              <div class="card">
                 <div class="card-body">
                    <div class="row">
                       <div class="col-xl-6">
                          <%if(unit_info.unit_images.length>0){%>
                          <div class="product-detai-imgs h-100">
                             <div class="row h-100 mb-2">
                                <div class="col-md-2 col-sm-3 col-4">
                                   <div class="nav flex-column nav-pills " id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                      <% for (var i = 0; i < unit_info.unit_images.length ; i++) { %>
                                      <% var active = "";
                                         var selected = "false";
                                             if(i==0){
                                                 active = "active";
                                                 selected = "true";
                                             }
                                         %>
                                      <a class="nav-link <%=active%>" id="product-tab-<%-i%>" data-toggle="pill" href="#product-<%-i%>" role="tab" aria-controls="product-1" aria-selected="<%=selected%>">
                                      <img src="<%= base_url %>/public/units/public-picture/<%= unit_info.unit_images[i].image_id %>" alt="" class="img-fluid mx-auto d-block rounded">
                                      </a>
                                      <%}%>                                            
                                   </div>
                                </div>
                                <div class="col-md-10 col-sm-9 col-8 h-100 d-flex">
                                   <div class="tab-content align-self-center p-4 w-100" id="v-pills-tabContent">
                                      <% for (var i = 0; i < unit_info.unit_images.length ; i++) { %>
                                      <% var active = "";
                                         var selected = "false";
                                         var show = "";
                                             if(i==0){
                                                 active = "active";
                                                 selected = "true";
                                                 show = "show";
                                             }
                                         %>
                                      <div class="tab-pane fade <%=show%> <%=active%>" id="product-<%-i%>" role="tabpanel" aria-labelledby="product-tab-<%-i%>">
                                         <div>
                                            <img src="<%= base_url %>/public/units/public-picture/<%= unit_info.unit_images[i].image_id %>" alt="" class="img-fluid mx-auto d-block rounded" height="100%">
                                         </div>
                                      </div>
                                      <%}%>                                             
                                   </div>
                                </div>
                             </div>
                          </div>
                          <%}else{%>
                          <div class="w-100 h-100  d-flex justify-content-center border border-warning rounded">
                             <div class="align-self-center text-center">
                                <h6 class="text-warning">Unit does not have any image!</h6>
                             </div>
                          </div>
                          <%}%>                           
                       </div>
                       <div class="col-xl-6">
                          <div class="mt-4 mt-xl-3">
                             <p class="text-info mb-0"><%=unit_lease.property_name %></p>
                             <h4 class="mt-1 mb-3"><%=unit_info.unit_name%> , <%=unit_info.floor%></h4>
                             <%- unit_info.ratings_message %>
                             <h5 class="mb-3">Monthly Rent : <b><span class="amount-value"><%=unit_lease.monthly_rent %></span></b></h5>
                             <h5 class="mb-4">Outstanding Balance : <b><span class="amount-value"><%=unit_lease.balance %></span></b></h5>
                             <div class="mt-0 button-items">
                                <p class="text-muted ml-2 mb-0">Features</p>
                                <% if(unit_info.internet_available){%>
                                <button class="text-muted btn btn-sm"><i class="bx bx-wifi font-size-16 align-middle text-primary mr-1"></i> Internet/Wifi</button>
                                <%}%>
                                <% if(unit_info.tv_cable_available){%>
                                <button class="text-muted btn btn-sm"><i class="bx bx-tv font-size-16 align-middle text-primary mr-1"></i> Tv Cable</button>
                                <%}%>
                                <% if(unit_info.has_balcony){%>
                                <button class="text-muted btn btn-sm"><i class="bx bx-chair font-size-16 align-middle text-primary mr-1"></i> Balcony</button>
                                <%}%>
                                <% if(unit_info.has_balcony){%>
                                <button class="text-muted btn btn-sm"><i class="bx bxs-tree font-size-16 align-middle text-primary mr-1"></i> Garden</button>
                                <%}%>
                                <% if(unit_info.pet_friendly){%>
                                <button class="text-muted btn btn-sm"><i class="bx bxl-baidu font-size-16 align-middle text-primary mr-1"></i> Pets</button>
                                <%}%>
                                <% if(unit_info.has_closet){%>
                                <button class="text-muted btn btn-sm"><i class="bx bx-closet font-size-16 align-middle text-primary mr-1"></i> Closet</button>
                                <%}%>
                                <% if(unit_info.has_laundry_room){%>
                                <button class="text-muted btn btn-sm"><i class="bx bxs-washer font-size-16 align-middle text-primary mr-1"></i> Laundry Room</button>
                                <%}%>                                   
                             </div>
                             <div class="mt-1">
                                <% if(unit_lease.status=='Active'){%>
                                <button type="button" class="btn btn-warning small-block mt-2 mr-1">
                                Lease Terminate Request
                                </button>
                                <%}%>                                          
                             </div>
                          </div>
                       </div>
                    </div>
                    <!-- end row -->
                    <div class="mt-5">
                       <h5 class="mb-3">Specifications :</h5>
                       <div class="table-responsive">
                          <table class="table mb-0 table-bordered">
                             <tbody>
                                <tr>
                                   <th scope="row">Unit Type:</th>
                                   <td><%=unit_info.unit_type%></td>
                                </tr>
                                <tr>
                                   <th scope="row">Floor:</th>
                                   <td><%=unit_info.floor%></td>
                                </tr>
                                <tr>
                                   <th scope="row">Garages:</th>
                                   <td><%=unit_info.garages%></td>
                                </tr>
                                <tr>
                                   <th scope="row">Bedrooms:</th>
                                   <td><%=unit_info.bedrooms%></td>
                                </tr>
                                <tr>
                                   <th scope="row">Bathrooms:</th>
                                   <td><%=unit_info.bathrooms%></td>
                                </tr>
                                <tr>
                                   <th scope="row">Water Source:</th>
                                   <td><%=unit_info.water_source%></td>
                                </tr>
                                <tr>
                                   <th scope="row">Floor Type:</th>
                                   <td><%=unit_info.floor_type%></td>
                                </tr>
                                <tr>
                                   <th scope="row">Furnishing:</th>
                                   <td><%=unit_info.furnishing%></td>
                                </tr>
                             </tbody>
                          </table>
                       </div>
                    </div>
                    <!-- end Specifications -->
                 </div>
              </div>
              <!-- end card -->
              <div class="row">
                 <div class="col">
                    <div class="card">
                       <div class="card-body p-2">
                          <!-- Nav tabs -->
                          <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                             <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#payments-tab" role="tab" aria-selected="true">
                                <span class="d-block d-sm-none"><i class='bx bxs-purchase-tag-alt font-size-24'></i></span>
                                <span class="d-none d-sm-block">Payments</span>   
                                </a>
                             </li>
                             <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#invoices-tab" role="tab" aria-selected="false">
                                <span class="d-block d-sm-none"><i class='bx bx-file-blank font-size-24'></i></span>
                                <span class="d-none d-sm-block">Invoices</span>    
                                </a>
                             </li>
                             <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#works-tab" role="tab" aria-selected="false">
                                <span class="d-block d-sm-none"><i class='bx bx-file-blank font-size-24'></i></span>
                                <span class="d-none d-sm-block">Work Orders</span>    
                                </a>
                             </li>
                             <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#readings-tab" role="tab" aria-selected="false">
                                <span class="d-block d-sm-none"><i class='bx bx-list-ul font-size-24'></i></i></span>
                                <span class="d-none d-sm-block">Meter Readings</span>    
                                </a>
                             </li>
                          </ul>
                          <!-- Tab panes -->
                          <div class="tab-content p-3">
                             <div class="tab-pane active" id="payments-tab" role="tabpanel">
                                <div class="table-responsive">
                                   <table id='tbl_payments' class="table table-nowrap border dt-responsive  table-hover" style="width:100%">
                                      <thead>
                                         <tr>
                                            <th scope="col">Date</th>
                                            <th scope="col">Invoice #</th>
                                            <th scope="col">Method</th>
                                            <th scope="col">Reference</th>
                                            <th scope="col">Amount</th>
                                            <th scope="col">Status</th>
                                         </tr>
                                      </thead>
                                   </table>
                                </div>
                             </div>
                             <div class="tab-pane" id="invoices-tab" role="tabpanel">
                                <div class="table-responsive">
                                   <table id='tbl_invoices' class="table table-nowrap border dt-responsive  table-hover" style="width:100%">
                                      <thead>
                                         <tr>
                                            <th scope="col">Date</th>
                                            <th scope="col">Invoice #</th>
                                            <th scope="col">Amount</th>
                                            <th scope="col">Balance</th>
                                            <th>Status</th>
                                         </tr>
                                      </thead>
                                   </table>
                                </div>
                             </div>
                             <div class="tab-pane" id="works-tab" role="tabpanel">
                                <div class="table-responsive">
                                   <table id='tbl_works' class="table table-nowrap border dt-responsive  table-hover" style="width:100%">
                                      <thead>
                                         <tr>
                                            <th scope="col">Date</th>
                                            <th scope="col">Invoice #</th>
                                            <th scope="col">Tenant</th>
                                            <th scope="col">Amount</th>
                                            <th scope="col">Balance</th>
                                            <th>Status</th>
                                            <th scope="col"></th>
                                         </tr>
                                      </thead>
                                   </table>
                                </div>
                             </div>
                             <div class="tab-pane" id="readings-tab" role="tabpanel">
                                <div class="table-responsive">
                                   <table id='tbl_readings_history' class="table table-nowrap border dt-responsive  table-hover" style="width:100%">
                                      <thead>
                                         <tr>
                                            <th scope="col">Date</th>
                                            <th scope="col">Meter Name</th>
                                            <th scope="col">Reading</th>
                                            <th scope="col">Rate</th>                                          
                                            <th scope="col">Billed</th>
                                            <th scope="col"></th>
                                         </tr>
                                      </thead>
                                   </table>
                                </div>
                             </div>
                          </div>
                       </div>
                    </div>
                 </div>
              </div>
              <div class="row">
                 <div class="col">
                    <div class="card">
                       <div class="card-body">
                          <h5>Reviews:</h5>
                          <div id="customer-reviews"> </div>
                          <div class="d-flex justify-content-center mt-2">
                             <button id="load-more-reviews" class="btn btn-light" type="button">Load More...</button>
                             <div>
                             </div>
                          </div>                
                        </div>
                    </div>
                 </div>
              </div>
              <!-- end reviews-->
              <div class="row">
                <div class="col">
                   <div class="card">
                      <div class="card-body">
                        <h5>Submit Review</h5>
                        <form id="frm-submit-review" action="#" method="post">
                          <div class="form-group">
                            <div class="mb-4">
                              <h5 class="font-size-14">Rating</h5>
                              <div class="custom-control custom-radio d-inline mr-1">
                                <input type="radio" id="user_rating_1" name="user_rating" class="custom-control-input" value='1'  checked="" >
                                <label class="custom-control-label" for="user_rating_1">1</label>
                            </div>
                            <div class="custom-control custom-radio d-inline mr-1">
                                <input type="radio" id="user_rating_2" name="user_rating" class="custom-control-input" value='2'>
                                <label class="custom-control-label" for="user_rating_2">2</label>
                            </div>
                            <div class="custom-control custom-radio d-inline mr-1">
                              <input type="radio" id="user_rating_3" name="user_rating" class="custom-control-input" value='3'>
                              <label class="custom-control-label" for="user_rating_3">3</label>
                          </div>
                          <div class="custom-control custom-radio d-inline mr-1">
                            <input type="radio" id="user_rating_4" name="user_rating" class="custom-control-input" value='4'>
                            <label class="custom-control-label" for="user_rating_4 mr-1">4</label>
                        </div>
                        <div class="custom-control custom-radio d-inline">
                          <input type="radio" id="user_rating_5" name="user_rating" class="custom-control-input" value='5'>
                          <label class="custom-control-label" for="user_rating_5">5</label>
                      </div>
                            </div>
                            <textarea name="user_comments" class='form-control' placeholder="Comment(s)" rows="6" maxlength="400" required></textarea>
                          </div>
                          <div class="custom-control custom-checkbox mb-3">
                              <input name='anonymous_review' type="checkbox" class="custom-control-input" id="anonymous_review">
                              <label class="custom-control-label" for="anonymous_review">Anonymous</label>
                          </div>

                          <button type='submit' class="btn btn-light">Submit Review</button>
                        </form>   
                      </div>
                    </div>
                  </div>
                </div>
              

           </div>
        </div>
     </div>
     <% if(!load_chunk){%> 
  </div>
  <%- include('../shared/page-footer') %> <%- include('../shared/admin-scripts') %> <%}%>
  <script>
     window.onload=function(){window.jQuery||window.location.reload()};     
     $(document).ready(function(){

      $('a[data-toggle="tab"]').on('shown.bs.tab', function(e){
    $($.fn.dataTable.tables(true)).DataTable()
            .columns.adjust()
            .responsive.recalc();
      }); 

      $("#frm-submit-review").validate({});
    
     $('input[type="checkbox"]').on("change",function(){this.value=this.checked?1:0}).change();
     
     $(".unit-floor").each(function () {        
         var f = parseInt($(this).attr("data-floor"));
         alert(f)
         $(this).html(", " + floorToLabel(f));
     });
     $(".amount-value").each(function () {        
         var f = parseFloat($(this).html());
         $(this).html(formatMoney(f));
     });
     
      $(".unit-lead").hover(
        function () {
               $(this).addClass("shadow-lg");
         },
         function () {
               $(this).removeClass("shadow-lg");
         }
      );
      $("#load-more-reviews").on('click', function(e){
        var last = $("#customer-reviews").children().last();
        loadReviews(last[0].id);
      });

     loadReviews(0);
     
     
     $("#tbl_payments").DataTable({
       responsive: !0,
       searchDelay: 500,
      processing: !0,
          serverSide: true,
       order: [],
       ajax: {
         url:
           "<%= base_url %>/tenant/leases/tenant-payments",
         type: "POST",
           async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
         data:{
           "lease_id":"<%=unit_lease.lease_id%>"
         }
       },
       columns: [    
         {
           data: "payment_date"
          
         },
         {
           data: "bill_code"
          
         },
         {
           data: "payment_method"
          
         },
         {
           data: "payment_ref"
          
         },        
         {
           data: null,
           className:"text-md-left, text-lg-right ",
           render: function(data, type, row){
               return formatMoney(data.payment_amount);
           }         
         },  
         {
     data: null,
     render: function(data, type, row) {
     var rp = '<span class="badge badge-soft-success">Completed</span>';
     if(data.is_cancelled) {
       rp = '<a class=" btn badge badge-soft-danger" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="a'+data.payment_id+'" href="#a'+data.payment_id+'" >Cancelled</a><div id="a'+data.payment_id+'" class="collapse mt-2 text-wrap alert alert-danger"><b>Reasons:</b> '+data.cancel_reasons +'</div>';
       
     }
     return rp;
     },
     }
        
       ],
     });
     
     $("#tbl_invoices").DataTable({
       responsive: !0,
       searchDelay: 500,
      processing: !0,
          serverSide: true,
       order: [],
       ajax: {
         url:
           "<%= base_url %>/tenant/leases/tenant-invoices",
         type: "POST",
           async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
         data:{
           "lease_id":"<%=unit_lease.lease_id%>"
         }
       },
       columns: [    
         {
           data: "bill_date"
          
         },
         {
           data: "bill_code"
          
         },
         {
            data: "total_amount",
            render: function(data, type, row) {
              return formatMoney(row.total_amount);
            }          
         },
         {
           data: null,
           render: function(data, type, row) {
              return formatMoney(row.total_amount - row.paid_amount)
           }
          
         },        
         {
           data: null,
           className:"text-md-left, text-lg-right ",
           render: function(data, type, row){
               if(row.is_cancelled){
                  return `<span class="badge badge-danger">Cancelled</span>`;
               }else if(row.total_amount - row.paid_amount>0){
                  return `<span class="badge badge-danger">Unpaid</span>`;
               }else{
                  return `<span class="badge badge-success">Paid</span>`;
               }
           }         
         }
     
        
       ],
     });
     
     $("#tbl_readings_history").DataTable({
       responsive: !0,
       searchDelay: 500,
      processing: !0,
          serverSide: true,
       order: [],
       ajax: {
         url:
           "<%= base_url %>/tenant/leases/meter-readings",
         type: "POST",
           async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
         data:{
           "lease_id":"<%=unit_lease.lease_id%>"
         }
       },
       columns: [    
         {
           data: "read_date"
          
         },
         {
           data: "reading_type"
          
         },
         {
           data: "read_value"
          
         },
         {
           data: "unit_rate"
          
         },        
         {
           data: "bill_generated",          
           render: function(data, type, row){
              if(row.bill_generated){
               return `<span class='badge badge-success'>Generated</span>`;
              }else{
               return `<span class='badge badge-danger'>Not Generated</span>`;
              }               
           }         
         }
     
        
       ],
     });
     
      
     
     });
     
     function loadReviews(start_point){
     
     $("#load-more-reviews").html(" <i class='bx bx-loader-circle bx-spin' ></i> Loading...");
     $("#load-more-reviews").attr("disabled", true);
     $.ajax({
              type: "POST",
          async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
              url: "<%= base_url %>/public/units/reviews",
              data: {"start":start_point, "unit_code":"<%=unit_info.unit_code%>"},
              success: function(data) {                
                $("#load-more-reviews").attr("disabled", false);
                $("#load-more-reviews").html("Load More...");
             
                if(data.data){ 
                  if(data.data.length>0){
                    if(data.data.length < 10){
                      $("#load-more-reviews").parent().remove();
                    }   
                    var rev = data.data;
                    for (var i = 0; i < rev.length; i++) {
                      var review = '<div id="'+ rev[i].rating_id +'" class="media py-3 border-bottom">';
                        if(rev[i].user_code === null){
                          review +='<div class="avatar-xs mr-3"> <span class="avatar-title bg-soft-danger text-danger rounded-circle font-size-16"> A </span> </div>';
                        }else{
                          review +=' <img src="<%= base_url %>/public/users/profile-image/' + rev[i].user_code +'" class="avatar-xs mr-3 rounded-circle" alt="">';
                        }
                        
                        review +='<div class="media-body "><div class="d-flex justify-content-between"> <h5 class="font-size-15">'+ rev[i].customer_name +'</h5>';
                          if(rev[i].verified_tenant){
                            review +='<span class=" btn-sm text-success"><i class="bx bx-check-double" ></i> Verified Tenant</span> '
                          }
                          review+= '</div><p class="text-muted">'+ starRatings(rev[i].user_rating) + '</p><p class="text-muted blockquote font-size-14">'+ rev[i].user_comments + '</p> <div class="text-muted font-size-12"><i class="bx bx-calendar text-primary mr-1"></i>'+ rev[i].rating_date +'</div> </div> </div>';                       
                        $("#customer-reviews").append(review);
                    }
                  
                  }  else{
                    $("#load-more-reviews").parent().remove();
                  }                         
                   
                }else{
                 $("#load-more-reviews").parent().remove();
                }                            
              },
              error: function(err) {  
                $("#load-more-reviews").attr("disabled", false);
                $("#load-more-reviews").html("Load More...");       
               //alert(JSON.stringify(err))                
               //showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
              }
          });
     }
     
      $("#frm-submit-review").on("submit", function(e) {
         e.preventDefault();
         var isvalid = $("#frm-submit-review").valid();

         if (isvalid) {
         $('#frm-submit-review button').html('Please wait..');
         $("#frm-submit-review button").attr("disabled", true);
            var data = new myFormData($(this));
            data.unit_code = "<%=unit_info.unit_code%>";  
            data.vt = 1;     
         $.ajax({
               type: "POST",
         async: true,  credentials: 'same-origin', headers: {'CSRF-Token': csrf_token},
               url: "<%= base_url %>/public/units/submit-review",
               data: data,
               success: function(data) {            
                  $('#frm-submit-review button').html('Submit Review');
                  $("#frm-submit-review button").attr("disabled", false);
                  if (data.Status == 200) {
                     $("#frm-submit-review").trigger('reset');
                     var ch = $("#customer-reviews").children().last();
                     let ll=0;
                     if(ch.length > 0) {
                     ll=ch[0].id;
                     } 
                     loadReviews(ll);
                     showAppNotification('success', data.Message);
                  } else {
                     showAppNotification('warning', data.Message);
                  }
               },
               error: function(err) {
               $('#frm-submit-review button').html('Submit Review');
                  $("#frm-submit-review button").attr("disabled", false);
                  showAppNotification( 'danger', 'Unable to complete your request. Please try again later!');
               }
         });
      }
      });

  </script>
  <% if(!load_chunk){%> </body></html> <%}%>